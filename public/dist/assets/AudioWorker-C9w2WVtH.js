(function(){"use strict";var c=function(){function i(e){this.begin=0,this.end=0,this.typedArrayConstructor=e,this.buffer=new e(16384)}return i.prototype.clear=function(){this.begin=this.end=0},i.prototype.reserve=function(e){for(this.begin==this.end&&this.clear();;){if(this.end+e<this.buffer.length){var t=this.end;return this.end+=e,t}if(this.begin>16384){this.buffer.set(this.buffer.subarray(this.begin,this.end)),this.end-=this.begin,this.begin=0;continue}var a=new this.typedArrayConstructor(this.buffer.length+e);a.set(this.buffer),this.buffer=a}},i.prototype.write=function(e,t){var a=this.reserve(t);this.buffer.set(e.subarray(0,t),a)},i.prototype.write_ptr=function(e){var t=this.reserve(e);return this.buffer.subarray(t,t+e)},i.prototype.read=function(e,t){t+this.begin>this.end&&console.error("Read out of bounds",t,this.end,this.begin),e!=null&&e.set(this.buffer.subarray(this.begin,this.begin+t)),this.begin+=t},i.prototype.read_ptr=function(e,t){return t===void 0&&(t=-1),t>this.occupancy()&&console.error("Read Pointer out of bounds",t),t<0&&(t=this.occupancy()),this.buffer.subarray(this.begin+e,this.begin+t)},i.prototype.occupancy=function(){return this.end-this.begin},i}();function h(i){return Math.floor(i)}var v=function(){function i(){this.is_initialized=!1,this.sample_rate=44100,this.channels=0,this.quick_search=!1,this.factor=0,this.search=0,this.segment=0,this.overlap=0,this.process_size=0,this.samples_in=0,this.samples_out=0,this.segments_total=0,this.skip_total=0}return i}(),_=function(){function i(e){var t=new v;t.channels=e,t.input_fifo=new c(Float32Array),t.output_fifo=new c(Float32Array),this.t=t}return i.prototype.difference=function(e,t,a){for(var o=0,s=0,s=0;s<a;s++)o+=Math.pow(e[s]-t[s],2);return o},i.prototype.tempo_best_overlap_position=function(e,t){var a=e.overlap_buf,o,s,n=e.search+1>>>1,f=64,r=s=e.quick_search?n:0,p,l=this.difference(t.subarray(e.channels*r),a,e.channels*e.overlap),u=0;if(e.quick_search)do{for(u=-1;u<=1;u+=2)for(o=1;(o<4||f==64)&&(r=n+u*o*f,!(r<0||r>=e.search));o++)p=this.difference(t.subarray(e.channels*r),a,e.channels*e.overlap),p<l&&(l=p,s=r);n=s}while(f>>>=2);else for(r=1;r<e.search;r++)p=this.difference(t.subarray(e.channels*r),a,e.channels*e.overlap),p<l&&(l=p,s=r);return s},i.prototype.tempo_overlap=function(e,t,a,o){var s=0,n=0,f=0,r=1/e.overlap;for(s=0;s<e.overlap;s++){var p=r*s,l=1-p;for(n=0;n<e.channels;n++,f++)o[f]=t[f]*l+a[f]*p}},i.prototype.process=function(){for(var e=this.t;e.input_fifo.occupancy()>=e.process_size;){var t,a;e.segments_total?(a=this.tempo_best_overlap_position(e,e.input_fifo.read_ptr(0)),this.tempo_overlap(e,e.overlap_buf,e.input_fifo.read_ptr(e.channels*a),e.output_fifo.write_ptr(e.overlap))):(a=e.search/2,e.output_fifo.write(e.input_fifo.read_ptr(e.channels*a,e.overlap),e.overlap)),e.output_fifo.write(e.input_fifo.read_ptr(e.channels*(a+e.overlap)),e.segment-2*e.overlap);var o=e.channels*e.overlap;e.overlap_buf.set(e.input_fifo.read_ptr(e.channels*(a+e.segment-e.overlap)).subarray(0,o)),e.segments_total++,t=h(e.factor*(e.segment-e.overlap)+.5),e.input_fifo.read(null,t)}},i.prototype.input=function(e,t,a){t===void 0&&(t=null),t==null&&(t=e.length);var o=this.t;o.samples_in+=t,o.input_fifo.write(e,t)},i.prototype.output=function(e){var t=this.t,a=Math.min(e.length,t.output_fifo.occupancy());return t.samples_out+=a,t.output_fifo.read(e,a),a},i.prototype.flush=function(){var e=this.t,t=h(e.samples_in/e.factor+.5),a=t>e.samples_out?t-e.samples_out:0,o=new Float32Array(128*e.channels);if(a>0){for(;e.output_fifo.occupancy()<a;)this.input(o,128),this.process();e.samples_in=0}},i.prototype.setup=function(e,t,a,o,s,n){a===void 0&&(a=!1),o===void 0&&(o=null),s===void 0&&(s=null),n===void 0&&(n=null);var f=1,r=this.t;r.sample_rate=e,o==null&&(o=Math.max(10,i.segments_ms[f]/Math.max(Math.pow(t,i.segments_pow[f]),1))),s==null&&(s=o/i.searches_div[f]),n==null&&(n=o/i.overlaps_div[f]);var p;if(r.quick_search=a,r.factor=t,r.segment=h(e*o/1e3+.5),r.search=h(e*s/1e3+.5),r.overlap=Math.max(h(e*n/1e3+4.5),16),r.overlap*2>r.segment&&(r.overlap-=8),!r.is_initialized)r.overlap_buf=new Float32Array(r.overlap*r.channels);else{var l=new Float32Array(r.overlap*r.channels),u=0;r.overlap*r.channels<r.overlap_buf.length&&(u=r.overlap_buf.length-r.overlap*r.channels),l.set(r.overlap_buf.subarray(u,r.overlap_buf.length)),r.overlap_buf=l}p=h(Math.ceil(t*(r.segment-r.overlap))),r.process_size=Math.max(p+r.overlap,r.segment)+r.search,r.is_initialized||r.input_fifo.reserve(h(r.search/2)),r.is_initialized=!0},i.prototype.setTempo=function(e){var t=this.t;this.setup(t.sample_rate,e,t.quick_search)},i.segments_ms=[82,82,35,20],i.segments_pow=[0,1,.33,1],i.overlaps_div=[6.833,7,2.5,2],i.searches_div=[5.587,6,2.14,2],i}();function b(i,e,t,a=1){var o=i.length/a,s=4096*a,n=new _(a);n.setup(t,e,!1);for(var f=new Float32Array(Math.floor(o/e*a+1)),r=0,p=0,l=!1;p<f.length;)if(p+=n.output(f.subarray(p,Math.min(p+s,f.length))),r<i.length){var u=i.subarray(r,Math.min(r+s,i.length));r+=u.length,n.input(u),n.process()}else l||(n.flush(),l=!0);return console.log("Finished stretching for rate: ",e),f}onmessage=i=>{console.log("Start stretching in parallel",i.data.stretchFactor),postMessage({data:b(i.data.data,i.data.stretchFactor,i.data.rate)})}})();
//# sourceMappingURL=AudioWorker-C9w2WVtH.js.map
